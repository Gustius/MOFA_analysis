---
title: "MOFA Simulations: analysis of bernoulli likelihood"
output:
  BiocStyle::html_document:
    toc: true
---

```{r}
devtools::load_all("/Users/ricard/mofa/MOFAtools")
library(MOFAtools)
library(data.table)
library(purrr)
library(ggplot2)
```

```{r}
theme_fn <- function() {
    theme(
    # plot.title = element_text(size=titlesize),
    plot.margin = margin(10,10,10,10),
    axis.title.x=element_text(colour="black",size=rel(1.75), margin=margin(20,0,3,0)),
    axis.title.y=element_text(colour="black",size=rel(1.75), margin=margin(0,20,0,3)),
    axis.text.x=element_text(colour="black",size=rel(1.5)),
    axis.text.y=element_text(colour="black",size=rel(1.5)),
    axis.ticks.x = element_line(colour="black"),
    axis.ticks.y = element_line(colour="black"),
    axis.line.x = element_line(color="black"),
    axis.line.y = element_line(color="black"),
    legend.position="none",
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.background = element_blank()
  )
}
```

<!-- Load bernoulli and gaussian models trained on binary data -->
```{r}

in.folder <- "/Users/ricard/data/MOFA/simulations/10Aug/results/nongaussian/binary"

# Load bernoulli models
files <- list.files(in.folder, pattern="^bernoulli")
bernoulli_models <- list()
for (i in 1:length(files)) {
  split <- strsplit(files[i],"_")[[1]]
  likelihood <- split[1]
  trial <- substr(split[[2]],1,nchar(split[[2]])-5)
  bernoulli_models[[paste(likelihood,trial,sep="_")]] <- loadModel(paste0(in.folder,"/",files[i]))
}
bernoulli_dt <- data.table(
  trial = as.numeric(sapply(strsplit(names(bernoulli_models),"_"),"[[",2)),
  elbo = sapply(bernoulli_models, function(x) tail(x@TrainStats$elbo,1) ),
  k = sapply(bernoulli_models, function(x) tail(x@TrainStats$activeK,1) ),
  likelihood="Bernoulli"
)

# Load gaussian models
files <- list.files(in.folder, pattern="^gaussian")
gaussian_models <- list()
for (i in 1:length(files)) {
  split <- strsplit(files[i],"_")[[1]]
  likelihood <- split[1]
  trial <- substr(split[[2]],1,nchar(split[[2]])-5)
  gaussian_models[[paste(likelihood,trial,sep="_")]] <- loadModel(paste0(in.folder,"/",files[i]))
}
gaussian_dt <- data.table(
  trial = as.numeric(sapply(strsplit(names(gaussian_models),"_"),"[[",2)),
  elbo = sapply(gaussian_models, function(x) tail(x@TrainStats$elbo,1) ),
  k = sapply(gaussian_models, function(x) tail(x@TrainStats$activeK,1) ),
  likelihood="Gaussian"
)

# Concatenate
dt <- rbind(bernoulli_dt,gaussian_dt) %>%
  .[,k:=k-1] # To account for the constant covariate that learns the mean

```

<!-- Compare Evidence lower bound -->
```{r}
p1 <- ggplot(dt, aes(x=likelihood, y=-log(-elbo))) +
  geom_boxplot(aes(fill=likelihood), alpha=0.5, outlier.shape=NA) +
  ggbeeswarm::geom_quasirandom(aes(color=likelihood)) +
  labs(x="", y="Log Evidence lower bound") +
  theme_fn()
print(p1)

pdf("/Users/ricard/CLL/simulations/nongaussian/out/bernoulli/bernoulli_elbo.pdf", width=7, height=5, useDingbats = F)
print(p1)
dev.off()
```

<!-- Compare number of active factors -->
```{r}
p2 <- ggplot(dt, aes(x=likelihood, y=k)) +
  geom_bar(aes(group = trial, fill=likelihood), position = "dodge", stat="identity", color="black") +
  geom_hline(yintercept = 10, color="black", size=0.6, linetype="solid") +
  labs(x="", y="Number of infered factors") +
  # scale_y_continuous(limits=c(0,15),breaks=c(5,10,15)) +
  # scale_x_continuous(limits=c(-0.03,0.93), breaks=c(0,0.05,0.1,0.15,0.2,0.25,0.3,0.35,0.4,0.45,0.5,0.55,0.6,0.65,0.7,0.75,0.8,0.85,0.9)) +
  theme_fn()
print(p2)

pdf("/Users/ricard/CLL/simulations/nongaussian/out/bernoulli/bernoulli_nfactors.pdf", width=7, height=5)
print(p2)
dev.off()
```

<!-- Compare reconstruction error -->
```{r}
sigmoid <- function(x) 1/(1+exp(-x))

dt[,mse:=Inf]
for (i in 1:length(gaussian_models)) {
  Y <- getTrainData(gaussian_models[[i]], views="0")
  Z <- getFactors(gaussian_models[[i]], include_intercept = T)
  SW <- getWeights(gaussian_models[[i]], views="0")
  Ypred_gaussian <- t(Z %*% t(SW))
  mse_gaussian <- mean((Ypred_gaussian - Y)**2)
  dt[likelihood=="Gaussian" & trial==i-1, mse:=mse_gaussian]
}
for (i in 1:length(bernoulli_models)) {
  Y <- getTrainData(bernoulli_models[[i]], views="0")
  Z <- getFactors(bernoulli_models[[i]], include_intercept = T)
  SW <- getWeights(bernoulli_models[[i]], views="0")
  Ypred_bernoulli <- sigmoid(t(Z %*% t(SW)))
  mse_bernoulli <- mean((Ypred_bernoulli - Y)**2)
  dt[likelihood=="Bernoulli" & trial==i-1, mse:=mse_bernoulli]
}

# Plot reconstruction error
p3 <- ggplot(dt, aes(x=likelihood, y=mse)) +
  geom_boxplot(aes(fill=likelihood), alpha=0.5, outlier.shape=NA) +
  ggbeeswarm::geom_quasirandom(aes(color=likelihood)) +
  labs(x="", y="Mean Squared Error") +
  theme_fn()
print(p3)

pdf("/Users/ricard/CLL/simulations/nongaussian/out/bernoulli/bernoulli_mse.pdf", width=7, height=5, useDingbats = F)
print(p3)
dev.off()
```

<!-- Compare distributions of reconstructed data -->
```{r}

# dt_truth <- getTrainData(poisson_models[[1]])[["0"]] %>% as.data.table %>% melt() %>% .[,likelihood:="Truth"]

Z <- getFactors(bernoulli_models[[1]], include_intercept = T)
SW <- getWeights(bernoulli_models[[1]], views="0")
dt_bernoulli <- sigmoid(t(Z %*% t(SW))) %>% as.data.table %>% melt() %>% .[,likelihood:="Bernoulli"]

Z <- getFactors(gaussian_models[[1]], include_intercept = T)
SW <- getWeights(gaussian_models[[1]], views="0")
dt_gaussian <- t(Z %*% t(SW)) %>% as.data.table %>% melt() %>% .[,likelihood:="Gaussian"]

dt <- rbind(dt_bernoulli, dt_gaussian)

p <- ggplot(dt, aes(x=value, group=likelihood, fill=likelihood)) +
  geom_histogram(aes(y=..density..), alpha=0.75, binwidth=0.1) +
  xlim(c(-1,2)) +
  labs(x="", y="Density") +
  theme_bw() +
  theme(
    axis.title.x=element_text(colour="black",size=rel(2.0)),
    axis.title.y=element_text(colour="black",size=rel(2.0)),
    axis.text.x=element_text(colour="black",size=rel(1.5)),
    axis.text.y=element_text(colour="black",size=rel(1.5)),
    axis.ticks.x = element_line(colour="black"),
    axis.ticks.y = element_line(colour="black"),
    legend.position="top",
    legend.key = element_rect(fill='white'),
    legend.text = element_text(size=rel(1.25)),
    legend.title = element_text(size=rel(1.5))
  )
print(p)

pdf("/Users/ricard/CLL/simulations/nongaussian/out/bernoulli/bernoulli_dist.pdf", width=6, height=4)
print(p)
dev.off()
```
