---
title: "Load MOFA models and technical inspections"
author: "Britta Velten"
date: "10/08/2017"
output:
  BiocStyle::html_document:
    toc: true
---

```{r, message=F, warning=F}
library(MOFAtools)
library(dplyr)
library(reshape2)
library(pheatmap)
library(survival)
library(gridExtra)
library(ggplot2)
library(GGally)
library(magrittr)
library(Hmisc)
library(cowplot)
library(pace)
```

# I/O - Options
```{r}
#output path for plots and data
plotdir <- "~/Documents/MOFA/CLL_MOFA_data/Analysis/code4manuscript/Figures_CLL_technical"
outdir <- "/Users/bvelten/Documents/MOFA/CLL_MOFA_data/Analysis/code4manuscript/"
if(!dir.exists(plotdir)) dir.create(plotdir)
if(!dir.exists(outdir)) dir.create(outdir)

# paths to data
#output directory containing .hdf5 output files from mofa
mofaDir <- "/Users/bvelten/Documents/MOFA/CLL_MOFA_data/out/test_final/17Aug/"
#data directory containing input files for MOFA
dataDir <-"/Users/bvelten/Documents/MOFA/CLL_MOFA_data/views/minView=2/"
```

# Load fitted models
In total, 25 models are fitted on patients with at least two views observed (n=200). k is learnt, mean is learned. For details see run_multiple.sh.
The following views are included: Mutations (>= 3 occurences), Methylation (top 1%, no XY), mRNA (top 5000, no Y), Drugs (all).

```{r}
files <- list.files(mofaDir)
files <- files[grepl(".hdf5",files)]

# load models, detect passengers and sort factors by R2
AllModels <- lapply(files, function (filenm) loadModel(file.path(mofaDir, filenm), sortFactors = T))

names(AllModels) <- sub(".hdf5","", files)
```

# Preparations
Set nice names
```{r}
# get gene annotations from ENSEMBL
mRNA_file <- "~/Documents/BioMart/Hsapiens_genes_BioMart.75.txt"
mRNA = read.csv(file=mRNA_file,header=T,sep="\t",stringsAsFactors=F)

# get drug annotations from pace
data("drugs")

# set feautre names and factor names
AllModels <- lapply(AllModels, function(model){
MOFAtools::featureNames(model)$mRNA <- mRNA$symbol[match(MOFAtools::featureNames(model)$mRNA, mRNA$ens_id)]
MOFAtools::featureNames(model)$Drugs <- paste(drugs[substr(MOFAtools::featureNames(model)$Drugs,1,5),"name"],
                                              substr(MOFAtools::featureNames(model)$Drugs,6,8), sep="")
MOFAtools::featureNames(model)$Mutations[MOFAtools::featureNames(model)$Mutations=="del13q14_any"] <- "del13q14"
MOFAtools::factorNames(model)[grepl("^0",MOFAtools::factorNames(model))] <- "intercept"
model
})
```


# Robustness to initilizations
```{r}
pdf(file.path(plotdir,"Robustness_CLL.pdf"), onefile = F, width = 7, height = 7)
cMout <- compareModels(AllModels, show_colnames=F, annotation_legend=F)
dev.off()
```


# Pick a model based on ELBO
```{r}
modelidx <- which.max(sapply(AllModels, function(model) model@TrainStats$elbo[length(model@TrainStats$elbo)]))
modelidx
model <- AllModels[[modelidx]]
```

Get relevant parts from model
```{r}
data <- model@TrainData
k <- model@Dimensions$K
Z <- getExpectations(model, "Z", "E")
weights <- getExpectations(model, "SW", "E")
```

Get other relevant covariates
```{r}
data("patmeta")
recurMuts <- t(data$Mutations[rowSums(data$Mutations, na.rm = T) >=5, ])
covariates <- cbind(recurMuts[,!grepl("IGHV", colnames(recurMuts))], patmeta[rownames(Z),])
colnames(covariates)[grep("Gender",colnames(covariates) )] <- "sex"
covariates$sex <- ifelse(covariates$sex == "m", 0,1)
colnames(covariates)[grep("Age4Main",colnames(covariates) )] <- "age"
colnames(covariates)[grep("ConsClust",colnames(covariates) )] <- "MethylationCluster"
covariates <- covariates[, !grepl("T5|T6|Age4Pilot|Age4Main|Diagnosis|died|treated|treatedAfter", colnames(covariates) )]
covariates$missingViews <- rowSums(sapply(data, function(dat) apply(is.na(dat), 2, all)))
```

# Flip sign of latent factors
To have a consisten hazard ratio for IGHV and its LF.
```{r}
Z[,"1"] <- -Z[,"1"]
```

# Correlation of latent factors
```{r}
pdf(file.path(plotdir,"FactorCor_CLL.pdf"), onefile = F, width = 8, height = 7)
fout <- FactorsCorPlot(model)
dev.off()
```

# Save workspace to be used in other down-stream analysis scripts
```{r}
rm(plotdir)
save(list=ls(), file="out_import_technical_.RData")
```

```{r}
sessionInfo()
```

