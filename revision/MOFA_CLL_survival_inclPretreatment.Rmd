---
title: "MOFA - CLL Survival Analysis using latent factors "
author: "Britta Velten"
date: "26/1/2018"
output:
  BiocStyle::html_document:
    toc: true
---

```{r, message=F, warning=F}
setwd("/Users/bvelten/Documents/MOFA/CLL_MOFA_data/Analysis/code4manuscript/")
library(MOFAtools)
library(dplyr)
library(reshape2)
library(pheatmap)
library(survival)
library(gridExtra)
library(ggplot2)
library(GGally)
library(magrittr)
library(Hmisc)
library(glmnet)
library(cowplot)
# library(pace)
```

# Get imported model and related data
Prepared in CLL_import_technical.Rmd
```{r}
load("out_import_technical_flipped.RData")
options(stringsAsFactors = FALSE)

#output path for plots
knitr::opts_chunk$set(fig.path = "Figures_CLL_survival_addClinical/", dev =c('png','pdf'))

# source helper functions
source("~/Documents/MOFA/CLL_MOFA_data/Analysis/code4manuscript/utils_SurvPrediction.R")
```

# Define colors for barplot
```{r}
# define colors
# cols4survival <- c("#999999", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7")
cols4survival <- c("#E69F00","#D55E00","#009E73", "#56B4E9",  "#999999","#0072B2","#0072B2","#0072B2","#0072B2", "#0072B2",
                   "brown", "brown", "brown", "brown", "pink")
names(cols4survival) <- c("Methylation", "Mutations","mRNA",  "Drugs", "all", "MOFA factors", "factor 1", "factor 7", "factor 8", "factors 1,7,8", "clinicalCovariates", "doublingTime", "pretreated", "both", "BothWithFactors")
```


# Get survival data
```{r}
survivalDataTTT <- as.matrix(patmeta[,c("T5","treatedAfter")])
survivalDataTTT<- survivalDataTTT[!is.na(survivalDataTTT[,1]),]
survivalDataOS <- as.matrix(patmeta[,c("T6","died")])
survivalDataOS <- survivalDataOS[!is.na(survivalDataOS[,1]),]
colnames(survivalDataOS) <- colnames(survivalDataTTT)<-c("time", "status")
listSurvData <- list(TTT= survivalDataTTT, OS=survivalDataOS)
```

# Load clinical covariates
```{r}
covariates_mofa <- covariates

load("~/Documents/cll/var/encPatientID_160218.RData")
rownames(encPatientID) <- encPatientID$PatientID

#
# From sampleExplorer, still contin duplicated samples, Junyan matched these already to pace data based on the date
# cellcounts <- read.csv("~/Documents/CLL/OtherData/2018-01-16_samples.csv")
# cellcounts  %<>% filter(screen_pilot67==1 | screen_IC50==1 |screen_VP5C1==1)
# cellcounts  %<>% mutate(Patient.ID2= encPatientID[as.character(Patient.ID),]$PatientID2)
# gplots::venn(list(rownames(Z), cellcounts$Patient.ID2))
# cellcounts  %<>% filter(Patient.ID2 %in% rownames(Z))
# filter(cellcounts, Patient.ID2%in%cellcounts$Patient.ID2[which(duplicated(cellcounts$Patient.ID2))])

# # cell counts matched data by Junyan
# cellcounts <- read.table("~/Documents/CLL/OtherData/cellCount_IC50.csv", sep = ";")
# colnames(cellcounts) <- c("PatID", cellcounts[1,-1])
# cellcounts <- cellcounts[-1,]
# rownames(cellcounts) <- cellcounts$PatID
# rownames(cellcounts) <- encPatientID[rownames(cellcounts),]$PatientID2
# cellcounts <- select(cellcounts,c('IC50 Leukocytes/\xb5l','pilot Leukocytes/\xe5\xb5l'))
# colnames(cellcounts) <- c("Leukocyte.count", "Leukocyte.count.pilot")
# cellcounts[which(!cellcounts[,1]==cellcounts[,2]),]
# cellcounts$Leukocyte.count <- as.numeric(cellcounts$Leukocyte.count)
# cellcounts$Leukocyte.count.pilot <- as.numeric(cellcounts$Leukocyte.count.pilot)
# # FOR SOME SAMPLES BOTH VALUES EXIST AND DIFFER QUIET A LOT< MEAN IS NOT IDEAL< WHAT IS THE MATCHING SAMPLE?
# cellcountsMean <- rowMeans(cellcounts, na.rm = T)

# doubling times (only available for 90 patients)
load("~/Documents/CLL/OtherData/DoublingTime_070816.RData")
LDT <- as.data.frame(LDT)
rownames(LDT) <- LDT$patID
rownames(LDT) <- encPatientID[rownames(LDT),]$PatientID2
doublingtimes <- LDT[rownames(Z),]$doubling.time
covariates <- cbind(covariates_mofa[rownames(Z),],
                    t(model@TrainData$Mutations)[rownames(Z),!colnames(t(model@TrainData$Mutations))%in% colnames(covariates_mofa)],
                    # Leukocyte.count=cellcountsMean[rownames(Z)],
                    doubling.times =doublingtimes)

biomarkers <- c("IGHV", "TP53", "age", "sex","MethylationCluster",
                 "pretreated",
                 "doubling times")
# biomarkers <- c("IGHV", "age","sex","MethylationCluster",
#                  "pretreated",
#                 "Leukocyte.count")

covariates[,"IGHV"] <- ifelse(covariates[,"IGHV"]=="U",0,1)
covariates[,"MethylationCluster"] <- ifelse(covariates[,"MethylationCluster"]=="LP",0,
                                            ifelse(covariates[,"MethylationCluster"]=="IP",0.5,1))

colnames(covariates) <- sapply(colnames(covariates), function(s) ifelse(s=="IC50beforeTreatment","pretreated",s) )
colnames(covariates) <- sapply(colnames(covariates), function(s) ifelse(s=="doubling.times","doubling times",s) )

all(biomarkers %in% colnames(covariates))
covariates <- covariates[,biomarkers]
```

# 4(a) Forest Plots
All covariates are scaled to ensure comparability of hazard ratio.This, however, looses interpretability of HR for 0-1 groups.
```{r}
  survType <- "TTT"
  # get either TTT ot OS data
  survivalData <-listSurvData[[survType]]
  
  # subset to common patients
  commonPats <- intersect(rownames(Z), rownames(survivalData))
  commonPats <- intersect(commonPats, rownames(covariates)[!apply(covariates,1, function(pat) any(is.na(pat)))])
  print(length(commonPats))
  Zcommon <- Z[commonPats,]
  covariatesCommon <- covariates[commonPats,]
  survivalData <- survivalData[commonPats,]
    
  # construct survival object
  SurvObject <-Surv(survivalData[,1],survivalData[,2])
  
  # fit a cox model for latent factors, scaling predictors
  pval_LFs<-sapply(which(apply(Z,2,var, na.rm=T)>0), function(i){
    fit <- coxph(SurvObject  ~  scale(Zcommon[,i]))  
    s <- summary(fit) 
    c(p      = s[["coefficients"]][, "Pr(>|z|)"], 
      coef   = s[["coefficients"]][, "exp(coef)"], 
      lower  = s[["conf.int"]][, "lower .95"], 
      higher = s[["conf.int"]][, "upper .95"])
  })
  colnames(pval_LFs) <- paste("Factor",colnames(Z)[which(apply(Z,2,var, na.rm=T)>0)])

  # fit a cox model for other relevant biomarkers, scaling all predictor
  pvals_Cov<-sapply(biomarkers, function(cnm){
    fit <- coxph(SurvObject  ~  scale(covariatesCommon[,cnm])) 
    s <- summary(fit) 
    c(p      = s[["coefficients"]][, "Pr(>|z|)"], 
      coef   = s[["coefficients"]][, "exp(coef)"], 
      lower  = s[["conf.int"]][, "lower .95"], 
      higher = s[["conf.int"]][, "upper .95"])
  })

  # collect in data frame
  pvalsSurv<-cbind(pval_LFs,pvals_Cov)
  df_survival <- as.data.frame(t(pvalsSurv))
  df_survival$predictor <- rownames(df_survival)
  types <- list(latentFactors = colnames(pval_LFs), 
                mutations = biomarkers[biomarkers%in% rownames(model@TrainData$Mutations)], 
                demographics  = biomarkers[grepl("sex|age", biomarkers)],
                clinical = biomarkers[grepl("doubling|pretreated", biomarkers)],
                other = biomarkers[grepl("MethylationCluster", biomarkers)])

  df_survival$predictorType <- with(df_survival, ifelse(predictor %in% types$latentFactors, "MOFA factors",
                              ifelse(predictor %in% types$mutations, "genetic",
                                     ifelse(predictor %in% types$clinical, "clinical",
                                            ifelse(predictor %in% types$demographics, "demographic", "other")))))
  df_survival$predictor <- factor(df_survival$predictor, levels = rev(Reduce(c, types)))
  df_survival$survType <- ifelse(survType=="TTT", "Time to next treatment", "Overall Survival")
  df_survival$label <- paste(formatC(df_survival$p, digits = 2), sep="")
  df_survival
  df_surv <- df_survival
```

## Forest plot
```{r forestplot}
col4Types <- c(cols4survival["MOFA factors"], cols4survival["Mutations"],
              "black", "darkgreen", cols4survival["Methylation"])
names(col4Types) <- c('MOFA factors', "genetic", "demographic", "clinical", "other")
gg_forest <- ggplot(filter(df_surv, !predictor %in% paste("Factor",1:10)| p < 0.01), aes(x=predictor,y=coef,ymin=lower,ymax=higher, col=predictorType))+
  geom_pointrange()+ coord_flip() +
  scale_x_discrete() + ylab("Hazard Ratio")+
  scale_y_log10(breaks=c(0.1,0.3,1,3), limits=c(min(df_surv$lower),5)) +
  geom_hline(aes(yintercept=1), linetype="dotted") + facet_wrap(~survType) +
  geom_text(aes(label=label, y=4),size=4.5, vjust = 0)+
  theme(text =element_text(size=16),
        axis.ticks.y = element_blank(),
        legend.position="bottom", panel.grid =element_blank(),
        panel.background = element_rect(fill="white"),
        strip.text = element_blank(),
        axis.text.y = element_text(size=16),
        plot.title = element_text(size=18)) +
  guides(colour=guide_legend("predictor type", ncol=2)) +
  xlab("") + scale_color_manual(values=col4Types)
gg_forest
```


# C-Index
Harrals C-Index is used as performance measure, 5-fold stratified cross-validation.
```{r}
df_hc <- lapply(c("TTT"), function(survType) {

  # get either TTT data
  survivalData <- listSurvData[[survType]]
  
  # subset to common patients
  commonPats <- intersect(rownames(Z), rownames(survivalData))
  commonPats <- intersect(commonPats, rownames(covariates)[!apply(covariates,1, function(pat) any(is.na(pat)))])
  print(length(commonPats))

  # add clinnical covariates as predictors
  covariatesCommon <- covariates[commonPats,]
  Zcommon <- Z[commonPats,]
  survivalData <- survivalData[commonPats,]
  print(paste("uncensored:",sum(survivalData[,2])))

  # construct survival object
  SurvObject <-Surv(survivalData[,1],survivalData[,2])
  
  #stratified CV to include same proportion of uncensored cases
  set.seed(1290)
  uncensored <- SurvObject[,"status"]==1
  cv_ix <- dismo::kfold(1:length(commonPats), k=5, by=uncensored)
  
  # add covariates from forest plot
  FeatureList <- list()
  FeatureList$factors = Zcommon[,c("1","7","8")]
  FeatureList$clinical <- covariatesCommon[colnames(covariatesCommon) %in% types$clinical]
  FeatureList$demographic <- covariatesCommon[colnames(covariatesCommon) %in% types$demographics]
  FeatureList$other <- covariatesCommon[colnames(covariatesCommon) %in% types$other]
  FeatureList$genetic <- covariatesCommon[colnames(covariatesCommon) %in% types$mutations]

  # fit a cox model and predict on left-out fold
  fit <- lapply(unique(cv_ix), function(i){
    
      #fit coxph for reduced
      c = lapply(FeatureList, function(x) coxph(SurvObject[cv_ix!=i,]  ~ as.matrix(x)[cv_ix!=i,]))
      p = mapply(function(x,y) as.matrix(x[cv_ix==i,]) %*% coef(y), FeatureList, c)
      
      CI=apply(-p,2, rcorr.cens, SurvObject[cv_ix==i])[1,]
      list(CI=CI,c=c)
  })

    # get cross-validated CI
    concordanceCV <- sapply(fit, function(l) l$CI)
    colnames(concordanceCV) <- unique(cv_ix)
    HcDF_cox <- melt(concordanceCV, varnames = c("predictor", "cv_idx"), value.name = "CI")
    HcDF_cox$survType <- ifelse(survType=="TTT", "Time to next treatment", "Overall Survival")
    HcDF_cox$predictor <- ifelse(HcDF_cox$predictor=="factors", "MOFA factors", as.character(HcDF_cox$predictor))
    HcDF_cox
}) %>% bind_rows()

# calculate summary statistics across folds
summaryHc <- aggregate(df_hc$CI,
    by = list(predictors = df_hc$predictor, survType=df_hc$survType), 
    FUN = function(x) c(mean = mean(x), sd = sd(x),
                        n = length(x)))
summaryHc <- do.call(data.frame, summaryHc)
summaryHc$se <- summaryHc$x.sd / sqrt(summaryHc$x.n)

summaryHc
```


## Barplot
```{r barplot}
limits <- aes(ymax = summaryHc$x.mean + summaryHc$se,
              ymin = summaryHc$x.mean - summaryHc$se)

# barplot
  gg_bar <- ggplot(summaryHc, aes(x=predictors, y=x.mean, fill=predictors, group=predictors))+
    geom_bar(stat = "identity") + 
   coord_cartesian(ylim = c(0.5,0.85)) +
  # ggtitle(paste("Prediction of time to treatment"))+
  scale_fill_manual(values=col4Types) + 
  geom_errorbar(limits, position = "dodge", width = 0.25)+
  theme(axis.text.x = element_text(angle = 90, vjust=0.5,hjust = 1, size=16, lineheight=-2),
        axis.text.y = element_text(size=16),
         axis.title.y = element_text(size=16),
        strip.background = element_rect(fill="white"),
        strip.text = element_blank(),
        legend.position= "none",
        plot.title = element_text(size=18)) +
  ylab("Harrell's C-index") + xlab("")
gg_bar
```

# Arrange plots
```{r TTT_clinical, fig.width=10, fig.height=7}
plot_grid(gg_forest, gg_bar, labels = c("a","b"), rel_widths=c(1.5,1))
```

